services:
  caddy:
    image: caddy:2-alpine
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
    depends_on:
      - brain
      - whatsapp
    restart: unless-stopped

  whatsapp:
    image: aldinokemal2104/go-whatsapp-web-multidevice:latest
    command: rest
    environment:
      WHATSAPP_WEBHOOK: 'http://brain:8000/webhook'
      WHATSAPP_WEBHOOK_SECRET: '${WEBHOOK_SECRET}'
      WHATSAPP_WEBHOOK_EVENTS: 'message'
      WHATSAPP_AUTO_MARK_READ: 'false'
      WHATSAPP_AUTO_DOWNLOAD_MEDIA: 'true'
    volumes:
      - whatsapp_data:/app/storages
    restart: unless-stopped

  brain:
    build: ./brain
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    environment:
      DATABASE_URL: 'postgresql+asyncpg://brain:${DB_PASS}@postgres/brain'
      REDIS_URL: 'redis://redis:6379/0'
      WHATSAPP_API_URL: 'http://whatsapp:3000'
      ANTHROPIC_API_KEY: '${ANTHROPIC_API_KEY}'
      ALEXA_SKILL_ID: '${ALEXA_SKILL_ID}'
      ALEXA_CLIENT_ID: '${ALEXA_CLIENT_ID}'
      ALEXA_CLIENT_SECRET: '${ALEXA_CLIENT_SECRET}'
      ALEXA_USER_ID: '${ALEXA_USER_ID}'
      WEBHOOK_SECRET: '${WEBHOOK_SECRET}'
      MEDIA_DIR: '/data/media'
      PUBLIC_BASE_URL: 'https://${DOMAIN}'
      WHISPER_ENABLED: '${WHISPER_ENABLED:-true}'
      WHISPER_MODEL: '${WHISPER_MODEL:-small}'
    volumes:
      - media_data:/data/media
    depends_on:
      - postgres
      - redis
      - whatsapp
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: brain
      POSTGRES_USER: brain
      POSTGRES_PASSWORD: '${DB_PASS}'
    volumes:
      - pg_data:/var/lib/postgresql/data
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --save 60 1
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  caddy_data:
  whatsapp_data:
  pg_data:
  redis_data:
  media_data:
