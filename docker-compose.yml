services:
  caddy:
    image: caddy:2-alpine
    ports:
      - '80:80'
      - '443:443'
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
    depends_on:
      - brain
      - whatsapp
    restart: unless-stopped

  whatsapp:
    image: aldinokemal2104/go-whatsapp-web-multidevice:latest
    command: rest
    environment:
      WHATSAPP_WEBHOOK: 'http://brain:8000/webhook'
      WHATSAPP_WEBHOOK_SECRET: '${WEBHOOK_SECRET}'
      WHATSAPP_WEBHOOK_EVENTS: 'message'
      WHATSAPP_AUTO_MARK_READ: 'false'
      WHATSAPP_AUTO_DOWNLOAD_MEDIA: 'true'
    volumes:
      - whatsapp_data:/app/storages
    restart: unless-stopped

  migrator:
    build: ./brain
    command: uv run alembic -c /app/alembic.ini upgrade head
    env_file: .env
    environment:
      DATABASE_URL: 'postgresql+asyncpg://brain:${DB_PASS}@postgres/brain'
    depends_on:
      postgres:
        condition: service_healthy
    restart: on-failure

  brain:
    build: ./brain
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    env_file: .env
    environment:
      # Sobrescreve URLs do .env para usar hostnames internos do compose
      DATABASE_URL: 'postgresql+asyncpg://brain:${DB_PASS}@postgres/brain'
      REDIS_URL: 'redis://redis:6379/0'
      WHATSAPP_API_URL: 'http://whatsapp:3000'
      PUBLIC_BASE_URL: 'https://${DOMAIN}'
      MEDIA_DIR: '/data/media'
    volumes:
      - media_data:/data/media
    depends_on:
      migrator:
        condition: service_completed_successfully
      redis:
        condition: service_started
      whatsapp:
        condition: service_started
    restart: unless-stopped

  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: brain
      POSTGRES_USER: brain
      POSTGRES_PASSWORD: '${DB_PASS}'
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U brain"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    command: redis-server --save 60 1
    volumes:
      - redis_data:/data
    restart: unless-stopped

volumes:
  caddy_data:
  whatsapp_data:
  pg_data:
  redis_data:
  media_data: